name: Security Scan - Secret Detection

on:
  pull_request:
    branches:
      - dev
      - main

permissions: 
  contents: read 
  pull-requests: write 
  actions: read
  
jobs:
  security_secret_scan:
    name: üîç Secret Detection & Reporting
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: üêç Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Install TruffleHog3 Security Scanner
        run: pip install trufflehog3

      - name: üîÑ Fetch Base Branch for Comparison
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: üìã Identify Changed Files in PR
        id: file_changes
        run: |
          git diff --name-only --diff-filter=AM origin/${{ github.event.pull_request.base.ref }}...HEAD > all_changed_files.txt
          
          # Apply exclusions from .securityignore file
          if [ -f ".github/security/.securityignore" ]; then
            echo "üìã Applying exclusions from .securityignore file..."
            
            # Start with all changed files
            cp all_changed_files.txt filtered_files.txt
            
            # Process each pattern in .securityignore
            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip empty lines and comments
              if [[ -z "$pattern" || "$pattern" =~ ^[[:space:]]*# ]]; then
                continue
              fi
              
              # Remove leading/trailing whitespace
              pattern=$(echo "$pattern" | xargs)
              
              # Skip if pattern is empty after trimming
              if [[ -z "$pattern" ]]; then
                continue
              fi
              
              echo "Excluding pattern: $pattern"
              
              # Convert glob-like patterns to grep-compatible regex
              # Handle ** (match any path depth)
              regex_pattern=$(echo "$pattern" | sed 's|\*\*|[^[:space:]]*|g' | sed 's|\*|[^/]*|g')
              
              # Filter out matching patterns
              grep -v -E "$regex_pattern" filtered_files.txt > temp_filtered.txt || touch temp_filtered.txt
              mv temp_filtered.txt filtered_files.txt
            done < .github/security/.securityignore
            
            mv filtered_files.txt changed_files.txt
          else
            echo "‚ö†Ô∏è No .github/security/.securityignore file found, using basic exclusions..."
            # Fallback to basic exclusions
            grep -v -E "\.github/security/.*\.yml$|\.github/workflows/rules\.yml$|rules\.yml$|rules\.yaml$" all_changed_files.txt > changed_files.txt || touch changed_files.txt
          fi
          
          echo "All changed files:"
          cat all_changed_files.txt
          echo ""
          echo "Files to be scanned (after exclusions):"
          cat changed_files.txt
          echo ""
          
          # Count files for reporting
          total_files=$(wc -l < all_changed_files.txt)
          scan_files=$(wc -l < changed_files.txt)
          excluded_files=$((total_files - scan_files))
          
          echo "files=$(cat changed_files.txt | xargs)" >> $GITHUB_OUTPUT
          echo "total_files=$total_files" >> $GITHUB_OUTPUT
          echo "scan_files=$scan_files" >> $GITHUB_OUTPUT
          echo "excluded_files=$excluded_files" >> $GITHUB_OUTPUT

      - name: üîß Debug Changed Files
        run: |
          echo "Current directory: $(pwd)"
          echo "List all files in repo:"
          find . -type f
          echo "Files to scan:"
          cat changed_files.txt


      - name: üîç Execute Security Scan on Modified Files
        id: security_scan
        run: |
          mkdir -p trufflehog_reports
          
          # Check if there are any files to scan
          if [ ! -s changed_files.txt ]; then
            echo "‚úÖ No files to scan after applying exclusions."
            echo "Creating empty report files for downstream steps..."
            
            # Create empty report files to prevent downstream failures
            echo "[]" > trufflehog_reports/report.json
            echo "<html><body><h1>No Files Scanned</h1><p>No files required scanning after applying exclusions.</p></body></html>" > trufflehog_reports/report.html
            
            # Set appropriate outputs
            echo "secrets_found=false" >> $GITHUB_OUTPUT
            echo "scan_status=‚úÖ No files scanned" >> $GITHUB_OUTPUT
            echo "files_scanned=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          files_scanned=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "üîç Scanning $file..."
              mkdir -p temp_scan
              cp "$file" temp_scan/
              trufflehog3 --zero --no-entropy --no-history --rules .github/security/rules.yml --format JSON -o trufflehog_reports/$(basename "$file").json temp_scan/
              rm -rf temp_scan
              ((files_scanned++))
            fi
          done < changed_files.txt

          echo "files_scanned=$files_scanned" >> $GITHUB_OUTPUT

          # Check if any reports were generated
          if ls trufflehog_reports/*.json 1> /dev/null 2>&1; then
            # Merge all scan results into consolidated report
            jq -s 'add' trufflehog_reports/*.json > trufflehog_reports/report.json
          else
            # No scan files generated, create empty report
            echo "[]" > trufflehog_reports/report.json
          fi

          # Set scan status for next steps
          if [ -f trufflehog_reports/report.json ] && grep -q '"severity":' trufflehog_reports/report.json; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "scan_status=‚ö†Ô∏è Potential secrets detected" >> $GITHUB_OUTPUT
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
            echo "scan_status=‚úÖ No secrets found" >> $GITHUB_OUTPUT
          fi

      - name: üìä Generate Comprehensive HTML Report
        id: report_generation
        run: |
          # Check if report.json exists and generate HTML report
          if [ -f "trufflehog_reports/report.json" ]; then
            echo "üìä Generating HTML report from scan results..."
            trufflehog3 -R trufflehog_reports/report.json --output trufflehog_reports/report.html
            cat trufflehog_reports/report.html
          else
            echo "‚ö†Ô∏è No report.json found, creating basic HTML report..."
            echo "<html><body><h1>Security Scan Report</h1><p>No scan performed or no results to display.</p></body></html>" > trufflehog_reports/report.html
          fi
          
          # Generate summary for PR comment
          echo "SCAN_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "## üîê Security Scan Results" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "**Scan Status:** ${{ steps.security_scan.outputs.scan_status }}" >> $GITHUB_ENV
          echo "**Files Changed:** ${{ steps.file_changes.outputs.total_files }}" >> $GITHUB_ENV
          echo "**Files Scanned:** ${{ steps.security_scan.outputs.files_scanned || steps.file_changes.outputs.scan_files }}" >> $GITHUB_ENV
          echo "**Files Excluded:** ${{ steps.file_changes.outputs.excluded_files }}" >> $GITHUB_ENV
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          if [ "${{ steps.security_scan.outputs.secrets_found }}" = "true" ]; then
            echo "### ‚ö†Ô∏è Action Required" >> $GITHUB_ENV
            echo "Potential secrets have been detected in your changes. Please review the detailed report below." >> $GITHUB_ENV
          elif [ "${{ steps.security_scan.outputs.files_scanned }}" = "0" ]; then
            echo "### ‚ÑπÔ∏è No Scan Required" >> $GITHUB_ENV
            echo "All changed files were excluded from security scanning (documentation, configuration files, etc.)." >> $GITHUB_ENV
          else
            echo "### ‚úÖ All Clear" >> $GITHUB_ENV
            echo "No secrets detected in the changed files. Great job maintaining security best practices!" >> $GITHUB_ENV
          fi
          echo "" >> $GITHUB_ENV
          
          # Add exclusion information if files were excluded
          if [ "${{ steps.file_changes.outputs.excluded_files }}" -gt 0 ]; then
            echo "**üìã Excluded Files:** Configuration and rules files are automatically excluded from security scanning." >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
          fi
          echo "---" >> $GITHUB_ENV
          echo "*This scan was performed using TruffleHog3 security scanner*" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üìé Upload HTML Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-report-html-${{ github.event.pull_request.number }}
          path: trufflehog_reports/report.html
          retention-days: 30

      - name: üìé Upload Raw JSON Data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-report-json-${{ github.event.pull_request.number }}
          path: trufflehog_reports/report.json
          retention-days: 30

      - name: üìù Post Security Scan Results to PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const scanSummary = process.env.SCAN_SUMMARY;
            const prNumber = context.payload.pull_request.number;
            
            // Check if there's already a comment from this bot
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîê Security Scan Results')
            );
            
            const commentBody = `${scanSummary}
            
            <!-- security-scan-comment -->`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing security scan comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new security scan comment');
            }

    
      - name: üö® Evaluate Scan Results
        if: always()
        run: |
          if [ "${{ steps.security_scan.outputs.secrets_found }}" = "true" ]; then
            echo "‚ùå Security scan failed! Potential secrets detected in the following files:"
            echo "Please review the detailed report and remove any sensitive information."
            echo ""
            echo "üìã Files that triggered alerts:"
            if [ -f changed_files.txt ]; then
              cat changed_files.txt
            else
              echo "No changed files list available"
            fi
            echo ""
            echo "üîç For detailed findings, check the HTML report in the PR comment above."
            exit 1
          elif [ "${{ steps.security_scan.outputs.files_scanned }}" = "0" ]; then
            echo "‚ÑπÔ∏è No files required security scanning after applying exclusions."
            echo "‚úÖ Security check completed successfully - no actionable files found."
          else
            echo "‚úÖ Security scan passed! No secrets detected in changed files."
            echo "All ${{ steps.security_scan.outputs.files_scanned }} scanned files are clean."
          fi
